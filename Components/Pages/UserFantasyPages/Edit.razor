@page "/user-fantasy/edit/{selectionId:int}"
@inject IDbContextFactory<LocalFantasyLeagueContext> DbFactory
@inject NavigationManager NavigationManager

<h3>Edit Fantasy Selection</h3>

<div>
    <label for="playerSelect" class="form-label">Select Players (Max 3 from the same team):</label>
    <select id="playerSelect" class="form-select" @onchange="OnPlayerSelected">
        <option value="">-- Select a Player --</option>
        @foreach (var player in Players)
        {
            <option value="@player.Id">@player.Name (@player.Team.Name)</option>
        }
    </select>
</div>

<div class="mt-3">
    <h5>Selected Players:</h5>
    <ul>
        @foreach (var player in SelectedPlayers)
        {
            <li>
                @player.Name
                <button class="btn btn-sm btn-danger" @onclick="() => RemovePlayer(player.Id)">Remove</button>
            </li>
        }
    </ul>
</div>

<div class="mt-3">
    <label for="captainSelect" class="form-label">Select Captain (Optional):</label>
    <select id="captainSelect" class="form-select" @bind="CaptainedPlayerId">
        <option value="">-- No Captain --</option>
        @foreach (var player in SelectedPlayers)
        {
            <option value="@player.Id">@player.Name</option>
        }
    </select>
</div>

<button class="btn btn-primary mt-3" @onclick="SaveSelection" disabled="@(!CanSave)">Save</button>

@code {
    [Parameter] public int SelectionId { get; set; }

    private List<Player> Players = new();
    private List<Player> SelectedPlayers = new();
    private int? CaptainedPlayerId;
    private bool CanSave => SelectedPlayers.Count == 3;

    protected override async Task OnInitializedAsync()
    {
        await using var context = await DbFactory.CreateDbContextAsync();

        // Load the existing selection
        var selection = await context.UserFantasySelections
            .FirstOrDefaultAsync(s => s.Id == SelectionId);

        if (selection != null)
        {
            // Load the players for the selection
            SelectedPlayers = await context.Players
                .Where(p => selection.Players.Contains(p.Id))
                .ToListAsync();

            // Set the captain
            CaptainedPlayerId = selection.CaptainedPlayerId;

            // Load all players for the match
            var match = await context.Matches
                .Include(m => m.HomeTeam)
                .Include(m => m.AwayTeam)
                .FirstOrDefaultAsync(m => m.Id == selection.MatchId);

            if (match != null)
            {
                Players = await context.Players
                    .Include(p => p.Team)
                    .Where(p => p.TeamId == match.HomeTeamId || p.TeamId == match.AwayTeamId)
                    .ToListAsync();
            }
        }
    }

    private void OnPlayerSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var playerId) && SelectedPlayers.Count < 3)
        {
            var player = Players.FirstOrDefault(p => p.Id == playerId);
            if (player != null && SelectedPlayers.All(p => p.Id != playerId))
            {
                SelectedPlayers.Add(player);
            }
        }
    }

    private void RemovePlayer(int playerId)
    {
        SelectedPlayers.RemoveAll(p => p.Id == playerId);
        if (CaptainedPlayerId == playerId)
        {
            CaptainedPlayerId = null;
        }
    }

    private async Task SaveSelection()
    {
        await using var context = await DbFactory.CreateDbContextAsync();

        // Update the existing selection
        var selection = await context.UserFantasySelections.FirstOrDefaultAsync(s => s.Id == SelectionId);
        if (selection != null)
        {
            selection.Players = SelectedPlayers.Select(p => p.Id).ToList();
            selection.CaptainedPlayerId = CaptainedPlayerId;
            await context.SaveChangesAsync();
        }

        // Navigate back to the main page
        NavigationManager.NavigateTo("/user-fantasy");
    }
}
