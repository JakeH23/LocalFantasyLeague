@page "/user-fantasy/create/{matchId:int}"
@rendermode InteractiveServer
@inject IDbContextFactory<LocalFantasyLeagueContext> DbFactory
@inject NavigationManager NavigationManager
@inject UserSession UserSession

<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3 class="card-title mb-0">Create Fantasy Selection</h3>
        </div>
        <div class="card-body">
            <EditForm Model="UserFantasySelection" OnValidSubmit="SaveSelection">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger mb-3" role="alert" />

                <div class="mb-4">
                    <h5 class="text-secondary">Select Players</h5>
                    <div class="row">
                        <div class="col-4">

                            <div class="form-group mb-3">
                                <label for="player1Select" class="form-label">Player 1</label>
                                <select id="player1Select" class="form-select" @bind="UserFantasySelection.Players[0]">
                                    <option value="">-- Select a Player --</option>
                                    @foreach (var player in Players)
                                    {
                                        <option value="@player.Id">@player.Name</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="form-group mb-3">
                                <label for="player2Select" class="form-label">Player 2</label>
                                <select id="player2Select" class="form-select" @bind="UserFantasySelection.Players[1]">
                                    <option value="">-- Select a Player --</option>
                                    @foreach (var player in Players)
                                    {
                                        <option value="@player.Id">@player.Name</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-4">

                            <div class="form-group mb-3">
                                <label for="player3Select" class="form-label">Player 3</label>
                                <select id="player3Select" class="form-select" @bind="UserFantasySelection.Players[2]">
                                    <option value="">-- Select a Player --</option>
                                    @foreach (var player in Players)
                                    {
                                        <option value="@player.Id">@player.Name</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>




                </div>

                <div class="mb-4">
                    <h5 class="text-secondary">Select Captain (Optional)</h5>
                    <div class="form-group">
                        <label for="captainSelect" class="form-label">Captain</label>
                        <select id="captainSelect" class="form-select" @bind="UserFantasySelection.CaptainedPlayerId">
                            <option value="">-- No Captain --</option>
                            @foreach (var playerId in UserFantasySelection.Players)
                            {
                                var player = Players.FirstOrDefault(p => p.Id == playerId);
                                if (player != null)
                                {
                                    <option value="@player.Id">@player.Name</option>
                                }
                            }
                        </select>
                    </div>
                </div>

                <div class="d-flex justify-content-end">
                    <button class="btn btn-primary" type="submit" disabled="@(!CanSave)">Save</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public int MatchId { get; set; }

    private UserFantasySelection UserFantasySelection = new()
        {
            MatchId = 0,
            Players = new List<int> { 0, 0, 0 }, // Initialize with placeholders for 3 players
            CaptainedPlayerId = null
        };

    private List<Player> Players = new();

    private bool CanSave => UserFantasySelection.Players.Count == 3 &&
                            UserFantasySelection.Players.All(p => p != 0) &&
                            UserFantasySelection.Players.Select(p => Players.FirstOrDefault(pl => pl.Id == p)?.TeamId).Distinct().Count() == 1;

    protected override async Task OnInitializedAsync()
    {
        await using var context = await DbFactory.CreateDbContextAsync();
        Players = await context.Players
            .Include(p => p.Team)
            .Where(p => p.TeamId == context.Matches.FirstOrDefault(m => m.Id == MatchId).HomeTeamId ||
                        p.TeamId == context.Matches.FirstOrDefault(m => m.Id == MatchId).AwayTeamId)
            .ToListAsync();

        UserFantasySelection.MatchId = MatchId;
    }

    private async Task SaveSelection()
    {
        await using var context = await DbFactory.CreateDbContextAsync();
        UserFantasySelection.UserId = UserSession.CurrentUser.Id;
        context.UserFantasySelections.Add(UserFantasySelection);
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/user-fantasy");
    }
}
