@page "/user-fantasy"
@inject IDbContextFactory<LocalFantasyLeague.Data.LocalFantasyLeagueContext> DbFactory
@inject UserSession UserSession

<h3>Fantasy Weeks</h3>
<div class="mb-3">
    <label for="teamFilter" class="form-label">Filter by Team:</label>
    <select id="teamFilter" class="form-select" disabled>
        <option value="">All Teams</option>
        @foreach (var team in Teams)
        {
            <option value="@team.Id">@team.Name</option>
        }
    </select>
</div>

<div class="table-responsive">
    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered">
            <thead>
                <tr>
                    <th>Kickoff</th>
                    <th>Home</th>
                    <th>Away</th>
                    <th>Result</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var match in Matches)
                {
                    <tr>
                        <td>@match.Kickoff.ToString("g")</td>
                        <td>@match.HomeTeam.Name</td>
                        <td>@match.AwayTeam.Name</td>
                        <td>
                            @if (match.Kickoff < DateTime.Now)
                            {
                                @($"{match.HomeTeamGoals} - {match.AwayTeamGoals}")
                            }
                            else
                            {
                                <span class="text-muted">TBD</span>
                            }
                        </td>
                        <td>
                            @if (UserSession.CurrentUser == null)
                            {
                                <a href="/matches/details/@match.Id">Details</a>
                            }
                            else
                            {
                                <a href="/matches/details/@match.Id">Details</a>
                                <a href="/matches/edit/@match.Id">Edit</a>
                                <a href="/matches/delete/@match.Id">Delete</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>


@code {
    private List<Match> Matches = new();
    private List<Team> Teams = new();
    private int? SelectedTeamId;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        Matches = await context.Matches
            .Include(m => m.HomeTeam)
            .Include(m => m.AwayTeam)
            .OrderBy(m => m.Kickoff)
            .ToListAsync();
        Matches = Matches.Where(x => x.HomeTeamId == UserSession.CurrentUser.TeamId || x.AwayTeamId == UserSession.CurrentUser.TeamId).ToList(); // Initially show all players

        Teams = await context.Teams.ToListAsync();
        Teams = Teams.Where(x => x.Id == UserSession.CurrentUser.TeamId).ToList();
    }
}
