@page "/fantasy-details"
@rendermode InteractiveServer
@inject IDbContextFactory<LocalFantasyLeagueContext> DbFactory

<h3>Fantasy Player Points and Stats</h3>

<!-- Season Filter -->
<div class="mb-3">
    <label for="seasonFilter" class="form-label">Filter by Season:</label>
    <select id="seasonFilter" class="form-select" @bind="SelectedSeasonId">
        <option value="0">-- All Seasons --</option>
        @foreach (var season in _seasons)
        {
            <option value="@season.Id">@season.Name (@season.StartDate.ToString("dd/MM/yyyy") - @season.EndDate.ToString("dd/MM/yyyy"))</option>
        }
    </select>
</div>

<!-- Team Filter -->
<div class="mb-3">
    <label for="teamFilter" class="form-label">Filter by Team:</label>
    <select id="teamFilter" class="form-select" @onchange="FilterPlayersByTeam">
        <option value="">All Teams</option>
        @foreach (var team in _teams)
        {
            <option value="@team.Id">@team.Name</option>
        }
    </select>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover table-bordered">
        <thead>
            <tr>
                <th>Name</th>
                <th>Team</th>
                <th>Appearances</th>
                <th><i class="fas fa-futbol"></i> Goals</th>
                <th>Assists</th>
                <th>Yellow Cards</th>
                <th>Red Cards</th>
                <th>Penalty Saves</th>
                <th>Clean Sheets</th>
                <th>Penalty Missed</th>
                <th class="highlight-column">Total Points</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var player in _filteredPlayersWithPoints.OrderByDescending(p => p.TotalPoints))
            {
                <tr>
                    <td>@player.Name</td>
                    <td>@player.TeamName</td>
                    <td class="numeric-column">@player.Appearances</td>
                    <td class="numeric-column">@player.Goals</td>
                    <td class="numeric-column">@player.Assists</td>
                    <td class="numeric-column">@player.YellowCards</td>
                    <td class="numeric-column">@player.RedCards</td>
                    <td class="numeric-column">@player.PenaltySaves</td>
                    <td class="numeric-column">@player.CleanSheets</td>
                    <td class="numeric-column">@player.PenaltyMissed</td>
                    <td class="numeric-column highlight-column">@player.TotalPoints</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private List<PlayerWithPoints> _playersWithPoints = [];
    private List<PlayerWithPoints> _filteredPlayersWithPoints = [];
    private List<Team> _teams = [];
    private List<Season> _seasons = [];
    private int? _selectedTeamId;
    private int SelectedSeasonId
    {
        get => _selectedSeasonId;
        set
        {
            _selectedSeasonId = value;
            FilterPlayersBySeason();
        }
    }
    private int _selectedSeasonId = 0;

    protected override async Task OnInitializedAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        var players = await db.Players.Include(p => p.PerformanceStats).Include(p => p.Team).ToListAsync();

        _teams = await DataService.GetAllAsync<Team>();
        _seasons = await DataService.GetAllAsync<Season>();

        _playersWithPoints = players.Select(player => new PlayerWithPoints
            {
                Name = player.Name,
                TeamName = player.Team?.Name ?? "No Team",
                TeamId = player.TeamId,
                Appearances = player.PerformanceStats.Count(stat => stat.Appearance),
                Goals = player.PerformanceStats.Sum(stat => stat.Goals),
                Assists = player.PerformanceStats.Sum(stat => stat.Assists),
                YellowCards = player.PerformanceStats.Count(stat => stat.YellowCard),
                RedCards = player.PerformanceStats.Count(stat => stat.RedCard),
                PenaltySaves = player.PerformanceStats.Sum(stat => stat.PenaltySaves),
                CleanSheets = player.PerformanceStats.Count(stat => stat.CleanSheet),
                PenaltyMissed = player.PerformanceStats.Sum(stat => stat.PenaltyMissed),
                TotalPoints = PointCalculator.CalculateTotalPoints(player.PerformanceStats),
                PerformanceStats = player.PerformanceStats
            }).ToList();

        _filteredPlayersWithPoints = _playersWithPoints; // Initially show all players
    }

    private void FilterPlayersByTeam(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var teamId))
        {
            _selectedTeamId = teamId;
            _filteredPlayersWithPoints = _playersWithPoints
                .Where(p => p.TeamId == teamId)
                .ToList();
        }
        else
        {
            _selectedTeamId = null;
            _filteredPlayersWithPoints = _playersWithPoints; // Show all players if no team is selected
        }

        StateHasChanged(); // Notify Blazor to re-render the UI
    }

    private async void FilterPlayersBySeason()
    {
        if (SelectedSeasonId != 0)
        {
            // Get the selected season
            var season = _seasons.FirstOrDefault(s => s.Id == SelectedSeasonId);
            if (season != null)
            {
                // Fetch matches for the selected season
                await using var db = await DbFactory.CreateDbContextAsync();
                var matchesInSeason = await db.Matches
                    .Where(m => m.SeasonId == season.Id)
                    .Select(m => m.Id)
                    .ToListAsync();

                // Filter players based on performance stats in the selected season
                _filteredPlayersWithPoints = _playersWithPoints
                    .Select(player =>
                    {
                        var filteredStats = player.PerformanceStats
                            .Where(stat => matchesInSeason.Contains(stat.MatchId))
                            .ToList();

                        return new PlayerWithPoints
                            {
                                Name = player.Name,
                                TeamName = player.TeamName,
                                TeamId = player.TeamId,
                                Appearances = filteredStats.Count(stat => stat.Appearance),
                                Goals = filteredStats.Sum(stat => stat.Goals),
                                Assists = filteredStats.Sum(stat => stat.Assists),
                                YellowCards = filteredStats.Count(stat => stat.YellowCard),
                                RedCards = filteredStats.Count(stat => stat.RedCard),
                                PenaltySaves = filteredStats.Sum(stat => stat.PenaltySaves),
                                CleanSheets = filteredStats.Count(stat => stat.CleanSheet),
                                PenaltyMissed = filteredStats.Sum(stat => stat.PenaltyMissed),
                                TotalPoints = PointCalculator.CalculateTotalPoints(filteredStats)
                            };
                    })
                    .Where(player => player.Appearances > 0) // Only include players with appearances
                    .ToList();
            }
        }
        else
        {
            // Show all players if no season is selected
            _filteredPlayersWithPoints = _playersWithPoints;
        }

        StateHasChanged(); // Notify Blazor to re-render the UI
    }
}
