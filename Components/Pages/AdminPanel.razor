@page "/admin"
@using LocalFantasyLeague.Models.DbSets
@inject IDbContextFactory<LocalFantasyLeagueContext> DbFactory

<h3 class="text-center my-4 text-danger">Admin: Actions to Complete</h3>

<!-- Actions to Complete Section -->
@if (_matchesToComplete.Any())
{
    <div class="table-responsive mb-5">
        <table class="table table-striped table-hover table-bordered">
            <thead class="bg-light text-dark">
                <tr>
                    <th>Kickoff</th>
                    <th>Match</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var match in _matchesToComplete)
                {
                    <tr>
                        <td>@match.Kickoff.ToString("d")</td>
                        <td>@match.HomeTeam?.Name vs @match.AwayTeam?.Name</td>
                        <td>
                            <a href="/matches/edit/@match.Id" class="btn btn-outline-danger btn-sm">Edit Match</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else if (_matchesNeedingSelections.Any())
{
    <h4 class="text-warning">Upcoming Matches Needing Selections</h4>
    <div class="table-responsive mb-5">
        <table class="table table-striped table-hover table-bordered">
            <thead class="bg-light text-dark">
                <tr>
                    <th>Kickoff</th>
                    <th>Match</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var match in _matchesNeedingSelections)
                {
                    <tr>
                        <td>@match.Kickoff.ToString("d")</td>
                        <td>@match.HomeTeam?.Name vs @match.AwayTeam?.Name</td>
                        <td>
                            <a href="/user-fantasy/create/@match.Id" class="btn btn-outline-warning btn-sm">Create Selection</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-success">You have no actions to complete</div>
}

@code {
    private List<Match> _matches = [];
    private List<Match> _matchesToComplete = [];
    private List<Match> _matchesNeedingSelections = [];

    protected override async Task OnInitializedAsync()
    {
        await using var context = await DbFactory.CreateDbContextAsync();

        // Load all matches
        _matches = await context.Matches
            .Include(m => m.HomeTeam)
            .Include(m => m.AwayTeam)
            .Include(m => m.Stats)
            .ToListAsync();

        // Filter matches that need actions (no stats)
        _matchesToComplete = _matches.Where(m => m.Kickoff < DateTime.Now && !m.Stats.Any()).ToList();

        // Filter upcoming matches in the next 7 days where the user has not created a selection
        var upcomingMatches = _matches.Where(m => m.Kickoff >= DateTime.Now && m.Kickoff <= DateTime.Now.AddDays(7)).ToList();

        var userSelections = await context.UserFantasySelections.Where(s => s.UserId == UserSession.CurrentUser!.Id).Select(s => s.MatchId).ToListAsync();

        _matchesNeedingSelections = upcomingMatches.Where(m => !userSelections.Contains(m.Id)).ToList();
    }
}
