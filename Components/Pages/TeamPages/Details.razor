@page "/teams/details/{id:int}"
@rendermode InteractiveServer
@inject IDbContextFactory<LocalFantasyLeagueContext> DbContextFactory

<h3 class="text-center my-4">Team Details</h3>

@if (Team == null)
{
    <div class="d-flex justify-content-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="container">
        <!-- Team Information -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Team Information</h4>
            </div>
            <div class="card-body">
                <p><strong>Name:</strong> @Team.Name</p>
            </div>
        </div>

        <!-- Players and Total Stats -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">
                    <button class="btn btn-link text-white text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#playersStats" aria-expanded="true" aria-controls="playersStats">
                        Players and Total Stats
                    </button>
                </h4>
            </div>
            <div id="playersStats" class="collapse show">
                <div class="card-body">
                    @if (Team.Players != null && Team.Players.Any())
                    {
                        <!-- Season Filter Dropdown -->
                        <div class="mb-3">
                            <label for="seasonFilter" class="form-label">Filter by Season:</label>
                            <select id="seasonFilter" class="form-select" @bind="SelectedSeasonId">
                                <option value="0">All Time</option>
                                @foreach (var season in _seasons)
                                {
                                    <option value="@season.Id">@season.Name (@season.StartDate.ToString("dd/MM/yyyy") - @season.EndDate.ToString("dd/MM/yyyy"))</option>
                                }
                            </select>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Player</th>
                                        <th>Appearances</th>
                                        <th>Goals</th>
                                        <th>Assists</th>
                                        <th>Yellow Cards</th>
                                        <th>Red Cards</th>
                                        <th>Penalty Saves</th>
                                        <th>Clean Sheets</th>
                                        <th>Penalty Missed</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var player in _filteredPlayers.OrderByDescending(p => p.Appearances))
                                    {
                                        <tr>
                                            <td>
                                                <a class="text-decoration-none" href="/players/details/@player.Id">
                                                    @player.Name
                                                </a>
                                            </td>
                                            <td class="numeric-column">@player.Appearances</td>
                                            <td class="numeric-column">@player.Goals</td>
                                            <td class="numeric-column">@player.Assists</td>
                                            <td class="numeric-column">@player.YellowCards</td>
                                            <td class="numeric-column">@player.RedCards</td>
                                            <td class="numeric-column">@player.PenaltySaves</td>
                                            <td class="numeric-column">@player.CleanSheets</td>
                                            <td class="numeric-column">@player.PenaltyMissed</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No players available for this team.</p>
                    }
                </div>
            </div>
        </div>

        <!-- Match Results -->
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">
                    <button class="btn btn-link text-dark text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#matchResults" aria-expanded="true" aria-controls="matchResults">
                        Match Results
                    </button>
                </h4>
            </div>
            <div id="matchResults" class="collapse show">
                <div class="card-body">
                    @if (_matches != null && _matches.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Season</th>
                                        <th>Total Matches</th>
                                        <th>Wins</th>
                                        <th>Losses</th>
                                        <th>Draws</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var seasonGroup in _matches
                                   .Where(m => m.Season != null)
                                   .GroupBy(m => m.Season!)
                                   .OrderByDescending(g => g.Key.StartDate))
                                    {
                                        var totalMatches = seasonGroup.Count();
                                        var wins = seasonGroup.Count(m => (m.HomeTeamId == Team.Id && m.HomeTeamGoals > m.AwayTeamGoals) || (m.AwayTeamId == Team.Id && m.AwayTeamGoals > m.HomeTeamGoals));
                                        var losses = seasonGroup.Count(m => (m.HomeTeamId == Team.Id && m.HomeTeamGoals < m.AwayTeamGoals) || (m.AwayTeamId == Team.Id && m.AwayTeamGoals < m.HomeTeamGoals));
                                        var draws = seasonGroup.Count(m => m.HomeTeamGoals == m.AwayTeamGoals);

                                        <tr>
                                            <a class="text-decoration-none" href="/seasons/details/@seasonGroup.Key.Id">
                                                @seasonGroup.Key.Name (@seasonGroup.Key.StartDate.ToString("dd/MM/yyyy") - @seasonGroup.Key.EndDate.ToString("dd/MM/yyyy"))                                            </a>
                                            <td class="numeric-column">@totalMatches</td>
                                            <td class="numeric-column">@wins</td>
                                            <td class="numeric-column">@losses</td>
                                            <td class="numeric-column">@draws</td>
                                        </tr>
                                    }

                                    <!-- Combined Results Row -->
                                    <tr class="table-secondary">
                                        <td><strong>All Time</strong></td>
                                        <td class="numeric-column"><strong>@_matches.Count</strong></td>
                                        <td class="numeric-column"><strong>@_matches.Count(m => (m.HomeTeamId == Team.Id && m.HomeTeamGoals > m.AwayTeamGoals) || (m.AwayTeamId == Team.Id && m.AwayTeamGoals > m.HomeTeamGoals))</strong></td>
                                        <td class="numeric-column"><strong>@_matches.Count(m => (m.HomeTeamId == Team.Id && m.HomeTeamGoals < m.AwayTeamGoals) || (m.AwayTeamId == Team.Id && m.AwayTeamGoals < m.HomeTeamGoals))</strong></td>
                                        <td class="numeric-column"><strong>@_matches.Count(m => m.HomeTeamGoals == m.AwayTeamGoals)</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No matches available for this team.</p>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private LocalFantasyLeagueContext _context = default!;
    private Team? Team { get; set; }
    private List<Match> _matches = [];
    private List<Season> _seasons = [];
    private int SelectedSeasonId
    {
        get => _selectedSeasonId;
        set
        {
            _selectedSeasonId = value;
            FilterStats();
        }
    }
    private int _selectedSeasonId;
    private List<PlayerStats> _filteredPlayers = [];

    protected override async Task OnInitializedAsync()
    {
        _context = await DbContextFactory.CreateDbContextAsync();

        Team = await _context.Teams
            .Include(t => t.Players)
            .ThenInclude(p => p.PerformanceStats)
            .FirstOrDefaultAsync(t => t.Id == Id);

        _matches = await _context.Matches
            .Where(m => m.HomeTeamId == Id || m.AwayTeamId == Id)
            .Include(m => m.Season)
            .ToListAsync();

        _seasons = await _context.Seasons
            .OrderByDescending(s => s.StartDate)
            .ToListAsync();

        // Pre-select the current season
        var today = DateTime.Today;
        SelectedSeasonId = _seasons.FirstOrDefault(s => today >= s.StartDate && today <= s.EndDate)?.Id ?? 0;

        FilterStats();
    }

    private void FilterStats()
    {
        if (SelectedSeasonId == 0) // All Time
        {
            _filteredPlayers = Team?.Players.Select(player => new PlayerStats
                {
                    Id = player.Id,
                    Name = player.Name,
                    Appearances = player.PerformanceStats.Count(s => s.Appearance),
                    Goals = player.PerformanceStats.Sum(s => s.Goals),
                    Assists = player.PerformanceStats.Sum(s => s.Assists),
                    YellowCards = player.PerformanceStats.Count(s => s.YellowCard),
                    RedCards = player.PerformanceStats.Count(s => s.RedCard),
                    PenaltySaves = player.PerformanceStats.Sum(s => s.PenaltySaves),
                    CleanSheets = player.PerformanceStats.Count(s => s.CleanSheet),
                    PenaltyMissed = player.PerformanceStats.Sum(s => s.PenaltyMissed)
                }).ToList() ?? [];
        }
        else // Filter by Season
        {
            _filteredPlayers = Team?.Players.Select(player => new PlayerStats
                {
                    Id = player.Id,
                    Name = player.Name,
                    Appearances = player.PerformanceStats.Count(s => s.Appearance && s.Match?.SeasonId == SelectedSeasonId),
                    Goals = player.PerformanceStats.Where(s => s.Match?.SeasonId == SelectedSeasonId).Sum(s => s.Goals),
                    Assists = player.PerformanceStats.Where(s => s.Match?.SeasonId == SelectedSeasonId).Sum(s => s.Assists),
                    YellowCards = player.PerformanceStats.Count(s => s.YellowCard && s.Match?.SeasonId == SelectedSeasonId),
                    RedCards = player.PerformanceStats.Count(s => s.RedCard && s.Match?.SeasonId == SelectedSeasonId),
                    PenaltySaves = player.PerformanceStats.Where(s => s.Match?.SeasonId == SelectedSeasonId).Sum(s => s.PenaltySaves),
                    CleanSheets = player.PerformanceStats.Count(s => s.CleanSheet && s.Match?.SeasonId == SelectedSeasonId),
                    PenaltyMissed = player.PerformanceStats.Where(s => s.Match?.SeasonId == SelectedSeasonId).Sum(s => s.PenaltyMissed)
                }).ToList() ?? [];
        }
    }

    private class PlayerStats
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public int Appearances { get; set; }
        public int Goals { get; set; }
        public int Assists { get; set; }
        public int YellowCards { get; set; }
        public int RedCards { get; set; }
        public int PenaltySaves { get; set; }
        public int CleanSheets { get; set; }
        public int PenaltyMissed { get; set; }
    }

    public async ValueTask DisposeAsync() => await _context.DisposeAsync();
}
